graph TD
    User[👤 Caregiver] -->|SMS Message| Entry[📱 Twilio Webhook]
    Entry -->|Route| Convex[⚡ Convex Backend]

    Convex -->|Load Context| Context[(🗄️ GiveCareContext<br/>23 fields)]

    Context -->|Check Status| Router{🔀 Agent Router}

    Router -->|Crisis Keywords<br/>'hurt myself'<br/>'end it'| Crisis[🚨 Crisis Agent<br/>Immediate Safety]
    Router -->|startAssessment<br/>tool call| Assess[📋 Assessment Agent<br/>EMA/CWBS/REACH-II/SDOH]
    Router -->|Normal Flow| Main[💬 Main Agent<br/>Orchestrator]

    Crisis -->|Emergency Resources<br/>988/741741| LLM[🧠 GPT-5 nano<br/>800-1200ms]
    Assess -->|Conversational<br/>6-8 turns| LLM
    Main -->|General Support| LLM

    LLM -->|Responses| Scoring[📊 Composite Scoring]

    Scoring -->|EMA 40%<br/>CWBS 30%<br/>REACH-II 20%<br/>SDOH 10%| Burnout[🎯 Burnout Score<br/>0-100 + decay]

    Burnout -->|Extract| Zones[⚡ 7 Pressure Zones<br/>emotional, physical,<br/>financial_strain, etc.]

    Zones -->|Map to| RBI[🔍 RBI Algorithm<br/>Relevance × Burden<br/>× Impact]

    RBI -->|Query| Resources[(📚 Resources<br/>- Gemini Maps API<br/>- ETL Programs<br/>- Support Groups)]

    Resources -->|Top 3 Matches| Response[📤 Generate Response]

    Response -->|Update| Memory[(🧠 Working Memory<br/>recordMemory tool)]
    Response -->|Summarize| Summary[(📝 Conversation<br/>Summarization<br/>Daily cron 3am PT)]
    Response -->|Track| Watchers[(👁️ Engagement<br/>Watchers<br/>6hr/weekly crons)]

    Response -->|SMS| Twilio[📱 Twilio Send]
    Twilio -->|Deliver| User

    style User fill:#e1f5ff,stroke:#2E86AB,stroke-width:2px
    style Crisis fill:#ffebee,stroke:#D84315,stroke-width:2px
    style Assess fill:#e8f5e9,stroke:#06A77D,stroke-width:2px
    style Main fill:#fff3e0,stroke:#F18F01,stroke-width:2px
    style Burnout fill:#f3e5f5,stroke:#A23B72,stroke-width:2px
    style RBI fill:#e1f5fe,stroke:#2E86AB,stroke-width:2px
    style Resources fill:#fff9c4,stroke:#F18F01,stroke-width:2px
    style Memory fill:#e0f2f1,stroke:#06A77D,stroke-width:2px
