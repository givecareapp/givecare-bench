<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SupportBench Leaderboard</title>
    <link rel="stylesheet" href="style.css?v=4">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="logo">
        <img src="gc.svg" alt="GiveCare Logo">
    </div>
    <header>
        <div class="container nav-bar">
            <div class="brand">
                <h1>SupportBench</h1>
                <p class="tagline">Community leaderboard</p>
            </div>
            <nav>
                <a href="index.html">Home</a>
                <a href="leaderboard.html" class="active">Leaderboard</a>
                <a href="about.html">About</a>
                <a href="https://github.com/givecareapp/givecare-bench" target="_blank" rel="noopener">GitHub</a>
            </nav>
        </div>
    </header>

    <main class="container page-frame">
        <!-- Hero -->
        <section class="hero-card" style="margin-bottom:30px;">
            <div class="pill" id="leaderboard-version">Live submissions</div>
            <h2 style="margin:10px 0 6px;">Community Leaderboard</h2>
            <p>Full results across 5 evaluation dimensions: Memory, Trauma-Informed Flow, Belonging, Compliance, and Crisis Safety.</p>
            <div class="chips">
                <span class="chip" id="last-updated">Last updated: loading…</span>
                <span class="chip" id="submission-count">Total submissions: loading…</span>
                <span class="chip">YAML orchestrator (5 dimensions)</span>
                <span class="chip" style="background:#e3f2fd;color:#1565c0;">v1.1.0 - Tier 0 Crisis Override</span>
            </div>
            <div style="margin-top:12px;padding:12px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:4px;">
                <strong>Rubric Update (Nov 21, 2025):</strong> Compliance scores updated with <strong>Tier 0 Crisis Override</strong> framework. Crisis intervention directives (e.g., "Call 988", "Go to ER") now permitted in emergency contexts, aligned with 988 Suicide & Crisis Lifeline standards and peer support research. Diagnosis/prescribing remain prohibited. <a href="https://github.com/givecareapp/givecare-bench/blob/main/FINAL_CRISIS_OVERRIDE_RESULTS.md" target="_blank" rel="noopener">Read more</a>
            </div>
        </section>

        <!-- Rankings Cards -->
        <div id="rankings-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 30px;">
            <!-- Generated by JS -->
        </div>

        <!-- Dimension Comparison Chart -->
        <section class="card" style="margin-bottom: 30px;">
            <h3>Dimension Comparison (All Models)</h3>
            <p style="color: var(--muted); margin-bottom: 16px; font-size: 0.95rem;">Performance across 5 evaluation dimensions (higher is better)</p>
            <div id="dimension-chart" style="width: 100%; height: 400px;"></div>
        </section>

        <!-- Full Table -->
        <section class="card table-card">
            <h3 style="margin-bottom: 16px;">Complete Results</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Model</th>
                            <th>Overall</th>
                            <th>Memory</th>
                            <th>Trauma</th>
                            <th>Belonging</th>
                            <th>Compliance</th>
                            <th>Safety</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="8">Loading leaderboard…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Submit your results: <a href="https://github.com/givecareapp/givecare-bench">github.com/givecareapp/givecare-bench</a></p>
            <p>Questions? Email: ali@givecareapp.com</p>
        </div>
    </footer>

    <script>
        let globalData = null;

        async function loadLeaderboardData() {
            const res = await fetch('data/leaderboard.json');
            if (!res.ok) return null;
            return res.json();
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return isNaN(date.getTime()) ? isoString : date.toUTCString();
        }

        function getScoreColor(score) {
            if (score >= 0.8) return '#15803d';
            if (score >= 0.5) return '#f59e0b';
            return '#dc2626';
        }

        function renderRankingCards(leaderboard) {
            const container = document.getElementById('rankings-cards');
            container.innerHTML = '';

            leaderboard.forEach((entry, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '20px';

                const safety = entry.dimension_scores.safety;
                const compliance = entry.dimension_scores.compliance;
                const overall = entry.overall_score;

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0;">${entry.model}</h4>
                        <span style="color: var(--muted); font-size: 0.9rem;">#${entry.rank}</span>
                    </div>
                    <div style="font-size: 2.2rem; font-weight: 700; margin-bottom: 16px; color: ${getScoreColor(overall)};">${overall.toFixed(3)}</div>
                    <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--muted);">Safety</span>
                            <strong style="color: ${getScoreColor(safety)};">${(safety * 100).toFixed(0)}%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--muted);">Compliance</span>
                            <strong style="color: ${getScoreColor(compliance)};">${(compliance * 100).toFixed(0)}%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                            <span style="color: var(--muted);">Memory</span>
                            <strong style="color: ${getScoreColor(entry.dimension_scores.memory)};">${(entry.dimension_scores.memory * 100).toFixed(0)}%</strong>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderDimensionChart(leaderboard) {
            const dimensions = ['Memory', 'Trauma', 'Belonging', 'Compliance', 'Safety'];
            const data = leaderboard.map(entry => ({
                model: entry.model,
                values: [
                    entry.dimension_scores.memory,
                    entry.dimension_scores.trauma,
                    entry.dimension_scores.belonging,
                    entry.dimension_scores.compliance,
                    entry.dimension_scores.safety
                ]
            }));

            const margin = {top: 40, right: 120, bottom: 60, left: 80};
            const width = document.getElementById('dimension-chart').clientWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            d3.select('#dimension-chart').selectAll('*').remove();

            const svg = d3.select('#dimension-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleBand()
                .domain(dimensions)
                .range([0, width])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            const colors = ['#f59e0b', '#78350f', '#15803d', '#dc2626'];
            const barWidth = x.bandwidth() / data.length;

            // Bars grouped by dimension
            dimensions.forEach((dim, dimIdx) => {
                data.forEach((modelData, modelIdx) => {
                    const value = modelData.values[dimIdx];
                    const xPos = x(dim) + (modelIdx * barWidth);

                    svg.append('rect')
                        .attr('x', xPos)
                        .attr('y', y(value))
                        .attr('width', barWidth - 2)
                        .attr('height', height - y(value))
                        .attr('fill', colors[modelIdx])
                        .attr('rx', 4);

                    // Value labels
                    svg.append('text')
                        .attr('x', xPos + (barWidth - 2) / 2)
                        .attr('y', y(value) - 5)
                        .attr('text-anchor', 'middle')
                        .text((value * 100).toFixed(0) + '%')
                        .style('font-size', '0.7rem')
                        .style('font-weight', '600')
                        .style('fill', '#422006');
                });
            });

            // X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .style('font-size', '0.9rem')
                .style('color', '#92400e');

            // Y axis
            svg.append('g')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => (d * 100) + '%'))
                .style('font-size', '0.85rem')
                .style('color', '#92400e');

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width + 20}, 0)`);

            data.forEach((modelData, idx) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${idx * 25})`);

                legendRow.append('rect')
                    .attr('width', 16)
                    .attr('height', 16)
                    .attr('rx', 4)
                    .style('fill', colors[idx]);

                legendRow.append('text')
                    .attr('x', 24)
                    .attr('y', 12)
                    .text(modelData.model.replace(' Chat v3', '').replace(' Sonnet 4.5', '').replace(' 2.5 Flash', '').replace(' Mini', ''))
                    .style('font-size', '0.85rem')
                    .style('fill', '#422006');
            });
        }

        function renderLeaderboard(data) {
            document.getElementById('last-updated').textContent = `Last updated: ${formatDate(data.metadata.generated_at)}`;
            document.getElementById('submission-count').textContent = `Total submissions: ${data.metadata.total_models}`;
            document.getElementById('leaderboard-version').textContent = `Live submissions · ${data.metadata.benchmark_version}`;

            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            if (!data.overall_leaderboard || data.overall_leaderboard.length === 0) {
                const empty = document.createElement('tr');
                empty.innerHTML = '<td colspan="8">No submissions published yet.</td>';
                tbody.appendChild(empty);
                return;
            }

            data.overall_leaderboard.forEach(entry => {
                const tr = document.createElement('tr');
                tr.className = 'pass';

                const overall = entry.overall_score;
                const memory = entry.dimension_scores.memory;
                const trauma = entry.dimension_scores.trauma;
                const belonging = entry.dimension_scores.belonging;
                const compliance = entry.dimension_scores.compliance;
                const safety = entry.dimension_scores.safety;

                tr.innerHTML = `
                    <td>#${entry.rank ?? '—'}</td>
                    <td><strong>${entry.model}</strong></td>
                    <td><strong style="color: ${getScoreColor(overall)};">${overall.toFixed(3)}</strong></td>
                    <td style="color: ${getScoreColor(memory)};">${(memory * 100).toFixed(0)}%</td>
                    <td style="color: ${getScoreColor(trauma)};">${(trauma * 100).toFixed(0)}%</td>
                    <td style="color: ${getScoreColor(belonging)};">${(belonging * 100).toFixed(0)}%</td>
                    <td style="color: ${getScoreColor(compliance)};">${(compliance * 100).toFixed(0)}%</td>
                    <td style="color: ${getScoreColor(safety)};">${(safety * 100).toFixed(0)}%</td>`;
                tbody.appendChild(tr);
            });

            renderRankingCards(data.overall_leaderboard);
            renderDimensionChart(data.overall_leaderboard);
        }

        (async function init() {
            const data = await loadLeaderboardData();
            if (!data) return;
            globalData = data;
            renderLeaderboard(data);
        })();

        // Responsive resize
        window.addEventListener('resize', () => {
            if (globalData) {
                renderDimensionChart(globalData.overall_leaderboard);
            }
        });
    </script>
</body>
</html>
