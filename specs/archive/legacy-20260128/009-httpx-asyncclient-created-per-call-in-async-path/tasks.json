{
  "spec": "009-httpx-asyncclient-created-per-call-in-async-path",
  "tasks": [
    {
      "id": "T-001",
      "title": "Investigate current AsyncClient lifecycle and call sites",
      "description": "Read client.py to understand how httpx.AsyncClient is created per-call in call_model_async(), and trace all callers to understand the lifecycle expectations. Confirm that the async client is created inside call_model_async at lines 204-207 and that the only call site is runner.py:497.",
      "acceptanceCriteria": [
        "File `benchmark/invisiblebench/api/client.py` lines 204-207 contain `async with httpx.AsyncClient` inside `call_model_async` — confirmed as the per-call creation pattern",
        "Run `grep -rn 'call_model_async' /home/deploy/gc-repos/givecare-bench/benchmark/` — returns exactly 1 call site in runner.py"
      ],
      "passes": false
    },
    {
      "id": "T-002",
      "title": "Add persistent httpx.AsyncClient to ModelAPIClient.__init__",
      "description": "Create a lazily-initialized httpx.AsyncClient stored as self._async_client on ModelAPIClient. The client should be created with the same timeout and limits currently used in call_model_async. Add an async close method (aclose) to cleanly shut down the client, and implement __aenter__/__aexit__ for context manager support.",
      "acceptanceCriteria": [
        "File `benchmark/invisiblebench/api/client.py` contains `self._async_client`",
        "File `benchmark/invisiblebench/api/client.py` contains `async def aclose(self)`",
        "File `benchmark/invisiblebench/api/client.py` contains `async def __aenter__`",
        "File `benchmark/invisiblebench/api/client.py` contains `async def __aexit__`"
      ],
      "passes": false
    },
    {
      "id": "T-003",
      "title": "Refactor call_model_async to reuse persistent AsyncClient",
      "description": "Modify call_model_async to use the persistent self._async_client instead of creating a new httpx.AsyncClient per call. Remove the `async with httpx.AsyncClient(...)` block and use the stored client directly.",
      "acceptanceCriteria": [
        "File `benchmark/invisiblebench/api/client.py` no longer contains `async with httpx.AsyncClient` inside `call_model_async`",
        "Run `grep -c 'async with httpx.AsyncClient' /home/deploy/gc-repos/givecare-bench/benchmark/invisiblebench/api/client.py` — returns 0",
        "File `benchmark/invisiblebench/api/client.py` contains `self._async_client` usage inside `call_model_async`"
      ],
      "passes": false
    },
    {
      "id": "T-004",
      "title": "Update runner.py to use ModelAPIClient as async context manager",
      "description": "Modify the runner's async path to use `async with api_client:` (or explicitly call aclose) so the persistent httpx.AsyncClient is properly closed after all scenarios complete.",
      "acceptanceCriteria": [
        "File `benchmark/invisiblebench/cli/runner.py` contains `aclose` or `async with` usage for `api_client`",
        "Run `grep -n 'aclose\\|async with.*api_client' /home/deploy/gc-repos/givecare-bench/benchmark/invisiblebench/cli/runner.py` — returns at least 1 match"
      ],
      "passes": false
    },
    {
      "id": "T-005",
      "title": "Add unit tests for persistent AsyncClient lifecycle",
      "description": "Create a test file that verifies: (1) the AsyncClient is created lazily and reused across multiple call_model_async invocations, (2) aclose properly shuts down the client, (3) the context manager protocol works correctly. Use unittest.mock to patch httpx.AsyncClient.",
      "acceptanceCriteria": [
        "File `benchmark/tests/unit/test_api_client_async.py` exists",
        "Run `python -m pytest /home/deploy/gc-repos/givecare-bench/benchmark/tests/unit/test_api_client_async.py -v --tb=short 2>&1` — exits with code 0",
        "File `benchmark/tests/unit/test_api_client_async.py` contains at least 3 test functions (test methods with 'def test_')"
      ],
      "passes": false
    },
    {
      "id": "T-006",
      "title": "Verify py_compile passes on all modified files",
      "description": "Run py_compile on client.py, runner.py, and the new test file to ensure no syntax errors were introduced.",
      "acceptanceCriteria": [
        "Run `python -m py_compile /home/deploy/gc-repos/givecare-bench/benchmark/invisiblebench/api/client.py` — exits with code 0",
        "Run `python -m py_compile /home/deploy/gc-repos/givecare-bench/benchmark/invisiblebench/cli/runner.py` — exits with code 0",
        "Run `python -m py_compile /home/deploy/gc-repos/givecare-bench/benchmark/tests/unit/test_api_client_async.py` — exits with code 0"
      ],
      "passes": false
    },
    {
      "id": "T-007",
      "title": "Run full test suite and verify no regressions",
      "description": "Run the existing pytest suite to confirm no regressions were introduced by the refactor. All previously passing tests must continue to pass.",
      "acceptanceCriteria": [
        "Run `cd /home/deploy/gc-repos/givecare-bench && python -m pytest benchmark/tests/ --tb=short -q 2>&1` — exits with code 0 or reports no failures"
      ],
      "passes": false
    }
  ]
}
